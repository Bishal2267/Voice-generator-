<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>कस्टम स्क्रिप्ट TTS जनरेटर</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .container {
            max-width: 4xl;
            width: 100%;
            padding: 2.5rem;
            background-color: #1e293b;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">
    <div class="container mx-auto flex flex-col gap-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-400">कस्टम स्क्रिप्ट TTS जनरेटर</h1>
        <p class="text-center text-slate-400">
            अपनी स्क्रिप्ट को नीचे दिए गए बॉक्स में डालें, जिसमें `<pause>` और `<emphasis>` जैसे टैग्स हों, और फिर "Generate Audio" पर क्लिक करें।
        </p>

        <textarea 
            id="scriptTextarea" 
            rows="15" 
            class="w-full p-4 bg-slate-900 text-slate-100 rounded-xl border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-y"
            placeholder="अपनी स्क्रिप्ट यहाँ लिखें..."
        >
<voice tone="warm" speed="0.95" pitch="+1">
नमस्कार दोस्तों... <pause=500ms>
स्वागत है... आपके पसंदीदा चैनल पर... <pause=400ms>
जहाँ हम विज्ञान... और ब्रह्मांड के वो राज़ खोलते हैं... <pause=500ms>
जिन्हें सुनकर... आपके दिमाग़ में सवालों का तूफ़ान आ जाता है। <pause=1s>

आज हम बात करेंगे... <pause=300ms>
ऐसे रहस्यमय पिंड की… <pause=300ms>
जो जितना दिखता है... उससे कहीं ज़्यादा छुपा हुआ है। <pause=600ms>
वो है... <emphasis>ब्लैक होल!</emphasis> <pause=800ms>
</voice>
        </textarea>
        
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <button 
                id="generateButton" 
                class="w-full sm:w-auto px-6 py-3 rounded-xl font-semibold text-lg text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50"
            >
                Generate Audio
            </button>
            <audio id="audioPlayer" controls class="w-full sm:w-auto h-12 rounded-xl border border-slate-700"></audio>
        </div>

        <div id="statusMessage" class="text-center text-sm font-medium text-slate-400"></div>

    </div>

    <script>
        const scriptTextarea = document.getElementById('scriptTextarea');
        const generateButton = document.getElementById('generateButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const statusMessage = document.getElementById('statusMessage');

        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM audio data to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const buffer = new ArrayBuffer(44 + pcmData.length * bytesPerSample);
            const view = new DataView(buffer);
            
            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
            view.setUint16(32, numChannels * bytesPerSample, true);
            view.setUint16(34, bytesPerSample * 8, true);
            
            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * bytesPerSample, true);
            
            // Write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * bytesPerSample, pcmData[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Helper function for writing strings to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        generateButton.addEventListener('click', async () => {
            const script = scriptTextarea.value;
            if (!script) {
                statusMessage.textContent = 'Please enter some text.';
                return;
            }

            // A very important step: Remove all the custom tags
            // This regex matches any tag like <tag> or <tag=value>, and also the '---' separator.
            const cleanedScript = script.replace(/<[^>]*>|---/g, '').trim();

            // Disable button and show loading status
            generateButton.disabled = true;
            statusMessage.textContent = 'Generating audio, please wait...';
            audioPlayer.src = '';
            
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: cleanedScript }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Rasalgethi" } 
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                
                if (!part || !part.inlineData || !part.inlineData.data) {
                    throw new Error('API response does not contain audio data.');
                }
                
                const audioData = part.inlineData.data;
                const mimeType = part.inlineData.mimeType;

                if (mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    statusMessage.textContent = 'Audio generated successfully. You can now play it.';
                } else {
                    throw new Error(`Unexpected MIME type: ${mimeType}`);
                }

            } catch (error) {
                console.error('Error generating audio:', error);
                statusMessage.textContent = `Error: ${error.message}. Please check your script and try again.`;
            } finally {
                generateButton.disabled = false;
            }
        });
    </script>
</body>
</html>
