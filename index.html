<!DOCTYPE html>
<html lang="hi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡§Æ‡§æ‡§®‡§µ ‡§ú‡•à‡§∏‡•Ä TTS ‡§ú‡§®‡§∞‡•á‡§ü‡§∞</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
    }
    
    .container {
      max-width: 4xl;
      width: 100%;
      padding: 2.5rem;
      background-color: #1e293b;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .loading-animation {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      
      100% {
        transform: rotate(360deg);
      }
    }
    
    .error-message {
      color: #f87171;
    }
  </style>
</head>

<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">
  <div class="container mx-auto flex flex-col gap-6">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-400">‡§Æ‡§æ‡§®‡§µ ‡§ú‡•à‡§∏‡•Ä TTS ‡§ú‡§®‡§∞‡•á‡§ü‡§∞</h1>
    <p class="text-center text-slate-400">
      ‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç‡•§ ‡§Ø‡§π ‡§ê‡§™ `<pause>`, `...` ‡§î‡§∞ `<emphasis>` ‡§ú‡•à‡§∏‡•á ‡§ü‡•à‡§ó‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§ï‡§∞ ‡§Æ‡§æ‡§®‡§µ ‡§ú‡•à‡§∏‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ‡•§
    </p>
    
    <textarea id="scriptTextarea" rows="15" class="w-full p-4 bg-slate-900 text-slate-100 rounded-xl border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-y" placeholder="‡§Ö‡§™‡§®‡•Ä ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç...">
‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç... <pause=500ms>
‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à... ‡§Ü‡§™‡§ï‡•á ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§ö‡•à‡§®‡§≤ ‡§™‡§∞... <pause=400ms>
‡§ú‡§π‡§æ‡§Å ‡§π‡§Æ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®... ‡§î‡§∞ ‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§æ‡§Ç‡§° ‡§ï‡•á ‡§µ‡•ã ‡§∞‡§æ‡§ú‡§º ‡§ñ‡•ã‡§≤‡§§‡•á ‡§π‡•à‡§Ç... <pause=500ms>
‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡•Å‡§®‡§ï‡§∞... ‡§Ü‡§™‡§ï‡•á ‡§¶‡§ø‡§Æ‡§æ‡§ó‡§º ‡§Æ‡•á‡§Ç ‡§∏‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡§æ ‡§§‡•Ç‡§´‡§º‡§æ‡§® ‡§Ü ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§ <pause=1s>

‡§Ü‡§ú ‡§π‡§Æ ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á... <pause=300ms>
‡§ê‡§∏‡•á ‡§∞‡§π‡§∏‡•ç‡§Ø‡§Æ‡§Ø ‡§™‡§ø‡§Ç‡§° ‡§ï‡•Ä‚Ä¶ <pause=300ms>
‡§ú‡•ã ‡§ú‡§ø‡§§‡§®‡§æ ‡§¶‡§ø‡§ñ‡§§‡§æ ‡§π‡•à... ‡§â‡§∏‡§∏‡•á ‡§ï‡§π‡•Ä‡§Ç ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§õ‡•Å‡§™‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à‡•§ <pause=600ms>
‡§µ‡•ã ‡§π‡•à... <emphasis>‡§¨‡•ç‡§≤‡•à‡§ï ‡§π‡•ã‡§≤!</emphasis> <pause=800ms>

‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à ‡§Ø‡•á...? <pause=300ms>
‡§î‡§∞ ‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§Ø‡•á... ‡§Ö‡§¨ ‡§§‡§ï ‡§ï‡•á ‡§∏‡§¨‡§∏‡•á ‡§¨‡§°‡§º‡•á ‡§ñ‡§ó‡•ã‡§≤‡•Ä‡§Ø ‡§∞‡§π‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§è‡§ï ‡§π‡•à...? <pause=1s>
‡§ö‡§≤‡§ø‡§è... ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ üöÄ
</textarea>
    
    <div class="flex flex-col sm:flex-row gap-4 items-center">
      <button id="generateButton" class="w-full sm:w-auto px-6 py-3 rounded-xl font-semibold text-lg text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-500/50 flex items-center justify-center gap-2">
        <div id="buttonText">‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</div>
        <div id="loadingIndicator" class="hidden loading-animation"></div>
      </button>
      <audio id="audioPlayer" controls class="w-full sm:w-auto h-12 rounded-xl border border-slate-700"></audio>
      <button id="downloadButton" class="w-full sm:w-auto px-6 py-3 rounded-xl font-semibold text-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg shadow-green-500/50 hidden">
        ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
      </button>
    </div>
    
    <div id="statusMessage" class="text-center text-sm font-medium text-slate-400"></div>
  </div>
  
  <script>
    // Helper function to convert base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }
    
    // Helper function to convert PCM audio data to WAV format
    function pcmToWav(pcmData, sampleRate) {
      const numChannels = 1;
      const bytesPerSample = 2; // 16-bit PCM
      const buffer = new ArrayBuffer(44 + pcmData.length * bytesPerSample);
      const view = new DataView(buffer);
      
      // RIFF chunk
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + pcmData.length * bytesPerSample, true);
      writeString(view, 8, 'WAVE');
      
      // FMT chunk
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true); // PCM format
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
      view.setUint16(32, numChannels * bytesPerSample, true);
      view.setUint16(34, bytesPerSample * 8, true);
      
      // Data chunk
      writeString(view, 36, 'data');
      view.setUint32(40, pcmData.length * bytesPerSample, true);
      
      // Write PCM data
      for (let i = 0; i < pcmData.length; i++) {
        view.setInt16(44 + i * bytesPerSample, pcmData[i], true);
      }
      
      return new Blob([view], { type: 'audio/wav' });
    }
    
    // Helper function for writing strings to DataView
    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }
    
    const scriptTextarea = document.getElementById('scriptTextarea');
    const generateButton = document.getElementById('generateButton');
    const audioPlayer = document.getElementById('audioPlayer');
    const downloadButton = document.getElementById('downloadButton');
    const statusMessage = document.getElementById('statusMessage');
    const buttonText = document.getElementById('buttonText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    let generatedAudioBlob = null; // Variable to store the generated audio blob
    
    // API call with exponential backoff for handling potential rate limits
    async function fetchWithExponentialBackoff(url, options, retries = 5, delay = 1000) {
      try {
        const response = await fetch(url, options);
        if (response.status === 429 && retries > 0) { // Too Many Requests
          console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
        }
        if (!response.ok) {
          throw new Error(`API returned status ${response.status}: ${response.statusText}. Please check the network tab for more details.`);
        }
        return await response.json();
      } catch (error) {
        if (retries > 0) {
          console.warn(`Fetch failed. Retrying in ${delay / 1000}s...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
        }
        throw error;
      }
    }
    
    // Main function to process the script and play audio
    async function processAndPlayScript() {
      const script = scriptTextarea.value;
      if (!script) {
        statusMessage.textContent = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§°‡§æ‡§≤‡•á‡§Ç‡•§';
        statusMessage.classList.add('error-message');
        return;
      }
      
      // Disable buttons and show loading status
      generateButton.disabled = true;
      downloadButton.classList.add('hidden');
      buttonText.textContent = '‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
      loadingIndicator.classList.remove('hidden');
      statusMessage.textContent = '‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...';
      statusMessage.classList.remove('error-message');
      audioPlayer.src = '';
      
      try {
        const payload = {
          contents: [{
            parts: [{ text: script }]
          }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: { voiceName: "Rasalgethi" }
              }
            }
          },
          model: "gemini-2.5-flash-preview-tts"
        };
        
        const apiKey = "AIzaSyCJrw4kXFE8ouz55P3pMRbjfsq8wMUsnlc";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        
        const result = await fetchWithExponentialBackoff(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        
        if (!part || !part.inlineData || !part.inlineData.data) {
          throw new Error('API response does not contain audio data. This may be due to an issue with the API key or the API itself. Please check the browser console and network tab for more details.');
        }
        
        const audioData = part.inlineData.data;
        const mimeType = part.inlineData.mimeType;
        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
        
        const pcmData = base64ToArrayBuffer(audioData);
        const pcm16 = new Int16Array(pcmData);
        const wavBlob = pcmToWav(pcm16, sampleRate);
        
        generatedAudioBlob = wavBlob;
        const audioUrl = URL.createObjectURL(wavBlob);
        
        audioPlayer.src = audioUrl;
        statusMessage.textContent = '‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§Ö‡§¨ ‡§∏‡•Å‡§® ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§';
        statusMessage.classList.remove('error-message');
        downloadButton.classList.remove('hidden'); // Show download button
        
      } catch (error) {
        console.error('Error generating audio:', error);
        statusMessage.textContent = `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`;
        statusMessage.classList.add('error-message');
      } finally {
        generateButton.disabled = false;
        buttonText.textContent = '‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç';
        loadingIndicator.classList.add('hidden');
      }
    }
    
    function downloadAudio() {
      if (generatedAudioBlob) {
        const url = URL.createObjectURL(generatedAudioBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_audio.wav';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); // Clean up the object URL
      }
    }
    
    generateButton.addEventListener('click', processAndPlayScript);
    downloadButton.addEventListener('click', downloadAudio);
  </script>
</body>

</html>